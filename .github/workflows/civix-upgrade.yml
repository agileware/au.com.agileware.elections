name: civix upgrade
on:
  push
env:
   COMPOSER_COMPILE: all
jobs:
  upgrade-and-push:
    runs-on: ubuntu-latest

    env:
      DB_NAME: wordpress
      DB_USER: wp_user
      DB_PASS: wp_pass
      DB_ROOT_PASS: root_pass
      DB_HOST: mariadb:3306
      WP_URL: http://localhost:8080
      WP_TITLE: Test Site
      WP_ADMIN_USER: admin
      WP_ADMIN_PASS: admin
      WP_ADMIN_EMAIL: test@example.com
      EXTENSION_NAME: au.com.agileware.elections

    services:
      mariadb:
        image: mariadb:10
        env:
          MYSQL_DATABASE: ${{ env.DB_NAME }}
          MYSQL_USER: ${{ env.DB_USER }}
          MYSQL_PASSWORD: ${{ env.DB_PASS }}
          MYSQL_ROOT_PASSWORD: ${{ env.DB_ROOT_PASS }}
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Create WP docker network
        run: |
          docker network create wp-net

      - name: Start WordPress container
        run: |
          docker run -d --name wordpress \
            --network wp-net \
            -e WORDPRESS_DB_HOST=${{ env.DB_HOST }} \
            -e WORDPRESS_DB_NAME=${{ env.DB_NAME }} \
            -e WORDPRESS_DB_USER=${{ env.DB_USER }} \
            -e WORDPRESS_DB_PASSWORD=${{ env.DB_PASS }} \
            -p 8080:80 \
            -v .:/var/www/html/wp-content/uploads/civicrm/ext/${{ env.EXTENSION_NAME }} \
            docker.io/agilewareprojects/wordpress:pipeline-latest
          docker exec -u www-data wordpress pwd
          docker exec -u www-data wordpress ls

      - name: Install WordPress
        run: |
          docker exec -u www-data wordpress wp core install \
            --url=${{ env.WP_URL }} \
            --title="${{ env.WP_TITLE }}" \
            --admin_user=${{ env.WP_ADMIN_USER }} \
            --admin_password=${{ env.WP_ADMIN_PASS }} \
            --admin_email=${{ env.WP_ADMIN_EMAIL }} \
            --skip-email

      - name: Download & install cv and civix
        run: |
          curl -Ls https://download.civicrm.org/cv/cv.phar -o /tmp/cv
          curl -Ls https://download.civicrm.org/civixcivix.phar -o /tmp/civix
          docker cp /tmp/cv wordpress:/usr/local/bin/cv
          docker cp /tmp/civix wordpress:/usr/local/bin/civix
          docker exec wordpress chmod +x /usr/local/bin/cv /usr/local/bin/civix

      - name: Install civicrm
        run: |
          docker exec rm -f ./uploads/civicrm/civicrm.settings.php
          docker exec -u www-data wordpress cv core:install
          docker exec -u www-data wordpress wp plugin activate wordpress

      - name: Regenerate module
        run: |
          docker exec wordpress -w /var/www/html/wp-content/uploads/civicrm/ext/${{ env.EXTENSION_NAME }} civix upgrade

      - name: Commit and push changes
        uses: devops-infra/action-commit-push@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          add_timestamp: true
          commit_prefix: "CIVIBLD-287 [AUTO] "
          commit_message: "civix upgraded"
          force: false
          target_branch: civix-upgrade

      - name: Create pull request
        uses: devops-infra/action-pull-request@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          body: "**Automated pull request** - civix regenerated"
          title: "Automated pull request - civix regenerated"
          assignee: "agileware-fj"
          label: "auto"
